require("colors");const glob=require("glob"),path=require("path"),chokidar=require("chokidar"),mm=require("micromatch"),{exec:exec,spawn:spawn}=require("child_process"),fs=require("fs"),MixGlob=function(){function e(e,o){return"string"==typeof o?o:!(!o||!o.hasOwnProperty(e))&&o[e]}function o(o,i,s){var t=e(o,i);return t||e(o,s)}function i(e,i,s,t,l,c,n){console.log("mixBaseGlob ===".bgBlue),console.log("Glob: ".yellow),console.log(i);const r=function(e){Array.isArray(e)||(e=[e]);const o=[];return e.forEach(e=>{console.log("glb glob mutli =".yellow),console.log(e),o.push(...glob.sync(e))}),console.log("files glob mutli".cyan),console.log(o),o}(i);let a,p,g,h,d;console.log("gb files ====".green),console.log(r),this.watchedFiles=[...this.watchedFiles,...r.filter(e=>!this.watchedFiles.includes(e))],console.log("Total watched files".cyan),console.log(this.watchedFiles),Array.isArray(i)||(i=[i]),this.watchedGlobs=[...this.watchedGlobs,...i],n||(this.watcher?(console.log("watching ==+>".blue),console.log(i.yellow),this.watcher.add(i)):(console.log("watching ==first+>".blue),console.log(i.yellow),this.watcher=chokidar.watch(i).on("add",e=>{if(mm.every(e,this.watchedGlobs)&&!this.watchedFiles.includes(e)){console.log("File added".bgCyan),console.log(e.yellow),console.log("restart...".cyan);const o=spawn("npm",["run","watch"],{detached:!0,stdio:"inherit",cwd:process.cwd()});!function(e){try{if(fs.existsSync("pid.log")){const o=fs.readFileSync("pid.log");o.push(e),fs.writeFileSync("pid.log",JSON.stringify(o))}else fs.writeFileSync("pid.log",JSON.stringify([e]))}catch(e){console.log(e.red)}}(o.pid),o.unref(),setTimeout(()=>{process.exit(0)},1e3)}})));let u,f=c;if(l||(l={}),l.compileSpecifier||(l.compileSpecifier={}),!l.compileSpecifier.disabled){let e="compile";l.compileSpecifier.specifier&&(e=l.compileSpecifier.specifier),h=new RegExp("."+e+".(?!.*"+e+".)","g")}l.extMapping&&(f=l.extMapping),r.forEach(i=>{a=l.base?i.replace(l.base,""):i,l.compileSpecifier.disable||(a=a.replace(h,".")),g=path.extname(a).substr(1),d=new RegExp(g+"$","g"),u=o(g,f,c),g!==u&&(a=a.replace(d,u)),p=path.join(s,a),this.mixInst=t?this.mixInst[e](i,p,t):this.mixInst[e](i,p)})}console.log("in MixGlob".yellow);var s,t={sass:{mapExt:"css"},js:{mapExt:"js"},less:{mapExt:"css"},stylus:{mapExt:"css"},react:{mapExt:"js"},ts:{mapExt:"js"},preact:{mapExt:"js"}};function l(e,i){let s=null;return t[e]&&(s=t[e].mapExt),function(e,i,s){const t=o(e,i,s);if(t)return t;throw"defaultMapExt: no mapping precised, neither it's supported by default"}(e,i,s)}function c(e){if(console.log("Mix glob".yellow),process&&process.stdout&&process.stdout.on("data",e=>{if(e=e.toString(),console.log("To quit type 'c' multiple times"),"c"===e.toString()||"C"===e){const e=function(){try{return fs.existsSync("pid.log")?JSON.parse(fs.readFileSync("pid.log")):[]}catch(e){return console.log(e),[]}}();console.log("closing ...".green),console.log("pids ".cyan+JSON.stringify(e).yellow),e.forEach(e=>{try{process.kill(e,"SIGINT")}catch(o){console.log("Error killing pid ".red+e)}}),fs.existsSync("pid.log")&&fs.unlinkSync("pid.log"),console.log("closed! CONTROL+C now".blue),process.exit(0)}}),process.on("SIGINT",()=>{setTimeout(()=>{console.log("SIGINT".bgRed),process.exit(0)},2e3)}),!e.mix)throw new Error("mix instance missing!");e&&e.mapping&&(this.mapping=e.mapping),e&&e.mapping||(this.mapping={}),this.mixInst=e.mix,this.watchedFiles=[],this.watchedGlobs=[],Object.keys(this.mixInst).forEach((e,o)=>{["mix","config","scripts","styles"].includes(e)||(this[e]=function(o,s,t,c){const n=l(e,this.mapping.mapExt);return i.call(this,e,o,s,t,c,n),this}.bind(this))})}return(s=c.prototype).createMapping=function(e){},s.mix=function(e){return function(){return this.mixInst[e].apply(this.mixInst,arguments),this}.bind(this)},c}();module.exports=MixGlob;