require("colors");const glob=require("glob"),path=require("path"),chokidar=require("chokidar"),mm=require("micromatch"),{exec:exec,spawn:spawn}=require("child_process"),MixGlob=function(){function e(e,o){return"string"==typeof o?o:!(!o||!o.hasOwnProperty(e))&&o[e]}function o(o,s,t){var i=e(o,s);return i||e(o,t)}function s(e,s,t,i,c,l,n){console.log("mixBaseGlob ===".bgBlue);const r=function(e){Array.isArray(e)||(e=[e]);const o=[];return e.forEach(e=>{console.log("glb glob mutli =".yellow),console.log(e),o.push(...glob.sync(e))}),console.log("files glob mutli".cyan),console.log(o),o}(s);let a,p,h,g,u;console.log("gb files ====".green),console.log(r),this.watchedFiles=[...this.watchedFiles,...r.filter(e=>!this.watchedFiles.includes(e))],console.log("watched files".cyan),console.log(this.watchedFiles),Array.isArray(s)||(s=[s]),this.watchedGlobs=[...this.watchedGlobs,...s],n||(this.watcher?(console.log("watching ==+>".blue),console.log(s.yellow),this.watcher.add(s)):(console.log("watching ==first+>".blue),console.log(s.yellow),this.watcher=chokidar.watch(s).on("add",e=>{if(mm.every(e,this.watchedGlobs)&&!this.watchedFiles.includes(e)){console.log("File added".bgCyan),console.log(e.yellow),console.log("restart...".cyan),spawn("npm",["run","watch"],{detached:!0,stdio:"inherit",cwd:process.cwd()}).unref(),setTimeout(()=>{process.exit(0)},1e3)}})));let m,d=l;if(c||(c={}),c.compileSpecifier||(c.compileSpecifier={}),!c.compileSpecifier.disabled){let e="compile";c.compileSpecifier.specifier&&(e=c.compileSpecifier.specifier),g=new RegExp("."+e+".(?!.*"+e+".)","g")}c.extMapping&&(d=c.extMapping),r.forEach(s=>{a=c.base?s.replace(c.base,""):s,c.compileSpecifier.disable||(a=a.replace(g,".")),h=path.extname(a).substr(1),u=new RegExp(h+"$","g"),m=o(h,d,l),h!==m&&(a=a.replace(u,m)),p=path.join(t,a),this.mixInst=i?this.mixInst[e](s,p,i):this.mixInst[e](s,p)})}console.log("in MixGlob".yellow);var t,i={sass:{mapExt:"css"},js:{mapExt:"js"},less:{mapExt:"css"},stylus:{mapExt:"css"},react:{mapExt:"js"},ts:{mapExt:"js"},preact:{mapExt:"js"}};function c(e,s){let t=null;return i[e]&&(t=i[e].mapExt),function(e,s,t){const i=o(e,s,t);if(i)return i;throw"defaultMapExt: no mapping precised, neither it's supported by default"}(e,s,t)}function l(e){if(console.log("Mix glob".yellow),console.log("process!!".bgBlue),console.log(process),process&&process.stdout&&(console.log("stdout ======".red),process.stdout.on("data",e=>{e=e.toString(),console.log("To quit type 'c' twice"),console.log(e),"c"!==e.toString()&&"C"!==e||(console.log("closed! CONTROL+C now".cyan),process.exit(0))})),process.on("SIGINT",()=>{setTimeout(()=>{console.log("SIGINT".bgRed),process.exit(0)},2e3)}),!e.mix)throw new Error("mix instance missing!");e&&e.mapping&&(this.mapping=e.mapping),e&&e.mapping||(this.mapping={}),this.mixInst=e.mix,this.watchedFiles=[],this.watchedGlobs=[],Object.keys(this.mixInst).forEach((e,o)=>{["mix","config","scripts","styles"].includes(e)||(this[e]=function(o,t,i,l){const n=c(e,this.mapping.mapExt);return s.call(this,e,o,t,i,l,n),this}.bind(this))})}return(t=l.prototype).createMapping=function(e){},t.mix=function(e){return function(){return this.mixInst[e].apply(this.mixInst,arguments),this}.bind(this)},l}();module.exports=MixGlob;